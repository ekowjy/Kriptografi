<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Enigma Visualizer ‚Äî Enkripsi & Dekripsi</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
    
    :root{
      --bg-primary: #0a0e27;
      --bg-secondary: #0f1432;
      --bg-tertiary: #151b42;
      --accent-blue: #3b82f6;
      --accent-purple: #8b5cf6;
      --accent-green: #10b981;
      --accent-cyan: #06b6d4;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border: rgba(148, 163, 184, 0.1);
      --glass: rgba(255, 255, 255, 0.03);
      --shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body { height: 100%; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, #0a1128 50%, #0d1538 100%);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }
    
    /* Animated background */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.05) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: bgMove 30s linear infinite;
      pointer-events: none;
      z-index: 0;
    }
    
    @keyframes bgMove {
      0% { transform: translate(0, 0); }
      100% { transform: translate(50px, 50px); }
    }
    
    .app { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 2rem;
      position: relative;
      z-index: 1;
    }
    
    /* Header */
    header {
      text-align: center;
      margin-bottom: 3rem;
      animation: fadeInDown 0.8s ease;
    }
    
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      letter-spacing: -0.02em;
    }
    
    .subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 2rem;
      animation: fadeIn 1s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Card */
    .card {
      background: rgba(15, 20, 50, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.75rem;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      border-color: rgba(59, 130, 246, 0.3);
      transform: translateY(-2px);
    }
    
    /* Section Titles */
    .section-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--accent-blue);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .section-title::before {
      content: '';
      width: 3px;
      height: 16px;
      background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple));
      border-radius: 2px;
    }
    
    /* Input Group */
    .input-group {
      margin-bottom: 1.25rem;
    }
    
    .input-label {
      display: block;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    input[type="text"], select {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      outline: none;
    }
    
    input[type="text"]:focus, select:focus {
      border-color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.05);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Grid Inputs */
    .grid-inputs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }
    
    .small-input {
      width: 100%;
      text-align: center;
      padding: 0.75rem 0.5rem;
    }
    
    /* Rotor Config */
    .rotor-config {
      display: grid;
      grid-template-columns: 1fr 140px;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    
    /* Buttons */
    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }
    
    button {
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
      position: relative;
      overflow: hidden;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    button:active::before {
      width: 300px;
      height: 300px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      color: white;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--accent-blue);
      color: var(--text-primary);
    }
    
    /* Keyboard */
    .keyboard {
      display: grid;
      grid-template-columns: repeat(13, 1fr);
      gap: 0.3rem;
      margin-top: 1rem;
    }
    
    .key {
      aspect-ratio: 1;
      background: linear-gradient(145deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      position: relative;
    }
    
    .key:hover {
      background: linear-gradient(145deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
      transform: translateY(-2px);
      border-color: var(--accent-blue);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .key:active {
      transform: translateY(0) scale(0.95);
    }
    
    /* Rotors Visual */
    .rotors-display {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
      padding: 2rem;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
      border-radius: 16px;
      border: 1px solid var(--border);
    }
    
    .rotor-visual {
      flex: 1;
      max-width: 140px;
      padding: 1.5rem 1rem;
      background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
      border: 2px solid var(--border);
      border-radius: 16px;
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .rotor-visual::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
      animation: scanline 2s linear infinite;
    }
    
    @keyframes scanline {
      0% { transform: translateY(0); }
      100% { transform: translateY(100px); }
    }
    
    .rotor-visual:hover {
      transform: translateY(-4px);
      border-color: var(--accent-blue);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }
    
    .rotor-title {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
      font-weight: 600;
    }
    
    .rotor-position {
      font-size: 3rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: 'JetBrains Mono', monospace;
      line-height: 1;
    }
    
    .reflector-visual {
      flex: 1;
      max-width: 140px;
      padding: 1.5rem 1rem;
      background: linear-gradient(145deg, rgba(139, 92, 246, 0.2), rgba(168, 85, 247, 0.2));
      border: 2px solid rgba(139, 92, 246, 0.3);
      border-radius: 16px;
      text-align: center;
    }
    
    .reflector-label {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-purple);
      font-family: 'JetBrains Mono', monospace;
    }
    
    /* Output Section */
    .output-section {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(6, 182, 212, 0.05));
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .output-display {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .light {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(16, 185, 129, 0.2);
      border: 2px solid rgba(16, 185, 129, 0.5);
      transition: all 0.3s ease;
      position: relative;
    }
    
    .light.on {
      background: var(--accent-green);
      border-color: var(--accent-green);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.6), 0 0 40px rgba(16, 185, 129, 0.4);
      animation: pulse 1s ease infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    .output-char {
      font-size: 2rem;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent-green);
      text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    }
    
    .path-display {
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem;
      border-radius: 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--text-secondary);
      overflow-x: auto;
      white-space: nowrap;
    }
    
    /* Log */
    .log {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      height: 200px;
      overflow-y: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.813rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    .log::-webkit-scrollbar {
      width: 8px;
    }
    
    .log::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }
    
    .log::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.3);
      border-radius: 4px;
    }
    
    .log::-webkit-scrollbar-thumb:hover {
      background: rgba(59, 130, 246, 0.5);
    }
    
    /* Reflector Panel */
    .reflector-panel {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(168, 85, 247, 0.05));
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
    }
    
    .reflector-canvas-container {
      margin-top: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 1rem;
    }
    
    #reflectorCanvas {
      width: 100%;
      border-radius: 8px;
    }
    
    .reflector-wiring {
      max-height: 120px;
      overflow-y: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--text-muted);
      padding: 0.5rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      margin-top: 0.75rem;
    }
    
    /* 3D Container */
    .three-container {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem;
      overflow: hidden;
    }
    
    #reflector3D {
      width: 100%;
      height: 300px;
      border-radius: 12px;
      overflow: hidden;
    }
    
    /* Footer */
    footer {
      text-align: center;
      margin-top: 3rem;
      padding: 2rem;
      color: var(--text-muted);
      font-size: 0.875rem;
      border-top: 1px solid var(--border);
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .grid { grid-template-columns: 1fr; }
      h1 { font-size: 2rem; }
    }
    
    @media (max-width: 768px) {
      .app { padding: 1rem; }
      .keyboard { grid-template-columns: repeat(7, 1fr); }
      .rotors-display { flex-wrap: wrap; }
      .btn-group { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>‚öôÔ∏è Enigma Machine Visualizer</h1>
      <p class="subtitle">Simulasi mesin enkripsi Enigma klasik dengan visualisasi 3D interaktif. Jelajahi bagaimana rotor, reflector, dan plugboard bekerja bersama untuk mengamankan pesan.</p>
    </header>

    <div class="grid">
      <!-- KONTROL -->
      <div class="card">
        <div class="section-title">üìù Input Pesan</div>
        <div class="input-group">
          <label class="input-label">Ketik teks (A-Z, karakter lain akan dipertahankan)</label>
          <input id="inputText" type="text" value="HELLO WORLD" placeholder="Masukkan pesan...">
        </div>

        <div class="section-title">‚öôÔ∏è Konfigurasi Rotor</div>
        <div class="rotor-config">
          <div class="input-group">
            <label class="input-label">Pilih Rotor</label>
            <div class="grid-inputs">
              <select id="rotorLeft" style="font-size:13px; padding:3px 5px; height:26px;">
                <option>I</option>
                <option>II</option>
                <option>III</option>
              </select>
              
              <select id="rotorMid" style="font-size:13px; padding:3px 5px; height:26px;">
                <option selected>II</option>
                <option>I</option>
                <option>III</option>
              </select>
              
              <select id="rotorRight" style="font-size:13px; padding:3px 5px; height:26px;">
                <option selected>III</option>
                <option>I</option>
                <option>II</option>
              </select>
              
            </div>
          </div>
          <div class="input-group">
            <label class="input-label">Reflector</label>
            <select id="reflector" style="
                font-size:13px;
                padding:3px 5px;
                height:26px;
                background:#000;
                color:#fff;
                border:1px solid #333;
                border-radius:6px;
            ">
              <option value="A">A</option>
              <option value="B" selected>B</option>
              <option value="C">C</option>
            </select>

          </div>
        </div>

        <div class="rotor-config">
          <div class="input-group">
            <label class="input-label">Ring Setting</label>
            <div class="grid-inputs">
              <input id="ringLeft" class="small-input" value="A" maxlength="1">
              <input id="ringMid" class="small-input" value="A" maxlength="1">
              <input id="ringRight" class="small-input" value="A" maxlength="1">
            </div>
          </div>
          <div class="input-group">
            <label class="input-label">Posisi Awal</label>
            <div class="grid-inputs">
              <input id="posLeft" class="small-input" value="A" maxlength="1">
              <input id="posMid" class="small-input" value="A" maxlength="1">
              <input id="posRight" class="small-input" value="A" maxlength="1">
            </div>
          </div>
        </div>

        <div class="input-group">
          <label class="input-label">üîå Plugboard (pasangan huruf, misal: AH BT CD)</label>
          <input id="plugboard" type="text" placeholder="Contoh: AH BT CD">
        </div>

        <div class="btn-group">
          <button id="run" class="btn-primary">üöÄ Enkripsi/Dekripsi</button>
          <button id="stepBtn" class="btn-secondary">‚ñ∂Ô∏è Step by Step</button>
          <button id="resetBtn" class="btn-secondary">üîÑ Reset</button>
          <button id="clearLog" class="btn-secondary">üóëÔ∏è Clear Log</button>
        </div>

        <div class="section-title" style="margin-top: 1.5rem;">‚å®Ô∏è Keyboard Virtual</div>
        <div id="keyboard" class="keyboard"></div>

        <div class="reflector-panel">
          <div class="section-title">üîÆ Reflector Mapping</div>
          <div style="display: flex; gap: 0.75rem; align-items: center; margin-bottom: 1rem;">
            <label class="input-label" style="margin: 0;">Pilih Reflector:</label>
            <select id="reflectorSelect" style="flex: 1;">
              <option value="A">Reflector A</option>
              <option value="B" selected>Reflector B</option>
              <option value="C">Reflector C</option>
            </select>
          </div>
          <div id="reflectorWiring" class="reflector-wiring"></div>
          <div class="reflector-canvas-container">
            <canvas id="reflectorCanvas" width="340" height="260"></canvas>
          </div>
        </div>
      </div>

      <!-- VISUALISASI -->
      <div class="card">
        <div class="section-title">üéØ Status Rotor</div>
        <div class="rotors-display">
          <div class="rotor-visual">
            <div class="rotor-title">Kiri</div>
            <div class="rotor-position" id="leftPos">A</div>
          </div>
          <div class="rotor-visual">
            <div class="rotor-title">Tengah</div>
            <div class="rotor-position" id="midPos">A</div>
          </div>
          <div class="rotor-visual">
            <div class="rotor-title">Kanan</div>
            <div class="rotor-position" id="rightPos">A</div>
          </div>
          <div class="reflector-visual">
            <div class="rotor-title">Reflector</div>
            <div class="reflector-label" id="reflectorLabel">B</div>
          </div>
        </div>

        <div class="section-title">üí° Output & Path</div>
        <div class="output-section">
          <div class="output-display">
            <span class="light" id="lightOut"></span>
            <span class="output-char" id="outChar">-</span>
          </div>
          <div class="path-display" id="lastPath">Jalur sinyal akan muncul di sini...</div>
        </div>

        <div class="section-title">üìÑ Ciphertext Result</div>
        <div class="output-section" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05)); border-color: rgba(59, 130, 246, 0.2);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <span style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600;">Hasil Enkripsi/Dekripsi:</span>
            <button id="copyBtn" class="btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
              üìã Copy
            </button>
          </div>
          <div id="ciphertext" style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 12px; font-family: 'JetBrains Mono', monospace; font-size: 1.125rem; color: var(--accent-cyan); word-wrap: break-word; min-height: 50px; display: flex; align-items: center; letter-spacing: 0.1em; font-weight: 600;">
            <span style="color: var(--text-muted); font-style: italic;">Hasil akan muncul di sini...</span>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 400px; gap: 1.5rem;">
          <div>
            <div class="section-title">üìã Log Proses</div>
            <div class="log" id="log"></div>
          </div>
          <div>
            <div class="section-title">üåê Reflector 3D</div>
            <div class="three-container">
              <div id="reflector3D"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p><strong>üí° Tip:</strong> Enigma bersifat simetris ‚Äî enkripsi dan dekripsi menggunakan proses yang sama dengan konfigurasi identik.</p>
    </footer>
  </div>

  <script>
  // ==================== ENIGMA CORE ====================
  const ALPH = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const rotorsSpec = {
    I:  { wiring: "EKMFLGDQVZNTOWYHXUSPAIBRCJ", notch: 'Q' },
    II: { wiring: "AJDKSIRUXBLHWTMCQGZNPYFVOE", notch: 'E' },
    III:{ wiring: "BDFHJLCPRTXVZNYEIWGAKMUSQO", notch: 'V' }
  };
  const REFLECTORS = {
    A: "EJMZALYXVBWFCRQUONTSPIKHGD",
    B: "YRUHQSLDPXNGOKMIEBFZCWVJAT",
    C: "FVPJIAOYEDRZXWGCTKUQSBNMHL"
  };

  function idx(c){ return ALPH.indexOf(c); }
  function chr(i){ return ALPH[(i+26)%26]; }

  function parsePlugboard(s){
    const map = {}; for (let c of ALPH) map[c]=c;
    if (!s) return map;
    s = s.toUpperCase().replace(/[^A-Z ]+/g,' ').trim();
    if (!s) return map;
    s.split(/\s+/).forEach(pair=>{
      if (pair.length===2){
        const a=pair[0], b=pair[1]; map[a]=b; map[b]=a;
      }
    });
    return map;
  }

  function Rotor(spec, ringSetting=0, pos=0){
    this.wiring = spec.wiring;
    this.notch = spec.notch;
    this.ring = ringSetting;
    this.pos = pos;
  }
  Rotor.prototype.forward = function(c){
    const shifted = (c + this.pos - this.ring + 26) % 26;
    const outChar = this.wiring[shifted];
    const outIdx = (ALPH.indexOf(outChar) - this.pos + this.ring + 26) % 26;
    return outIdx;
  }
  Rotor.prototype.backward = function(c){
    const shifted = (c + this.pos - this.ring + 26) % 26;
    const idxInWiring = this.wiring.indexOf(ALPH[shifted]);
    const outIdx = (idxInWiring - this.pos + this.ring + 26) % 26;
    return outIdx;
  }
  Rotor.prototype.step = function(){ this.pos = (this.pos + 1) % 26; }
  Rotor.prototype.atNotch = function(){ return ALPH[this.pos] === this.notch; }

  // ==================== UI REFS ====================
  const inputText = document.getElementById('inputText');
  const runBtn = document.getElementById('run');
  const stepBtn = document.getElementById('stepBtn');
  const resetBtn = document.getElementById('resetBtn');
  const clearLog = document.getElementById('clearLog');
  const logEl = document.getElementById('log');
  const outChar = document.getElementById('outChar');
  const lastPath = document.getElementById('lastPath');
  const lightOut = document.getElementById('lightOut');
  const keyboard = document.getElementById('keyboard');
  const reflectorSelect = document.getElementById('reflectorSelect');
  const reflectorLabel = document.getElementById('reflectorLabel');
  const ciphertextEl = document.getElementById('ciphertext');
  const copyBtn = document.getElementById('copyBtn');

  // Keyboard
  for (let i=0;i<26;i++){ 
    const c=ALPH[i]; 
    const k=document.createElement('div'); 
    k.className='key'; 
    k.textContent=c; 
    k.onclick=()=>{ inputText.value += c; }; 
    keyboard.appendChild(k); 
  }

  // ==================== REFLECTOR 2D ====================
  const canvas = document.getElementById('reflectorCanvas');
  const ctx = canvas.getContext('2d');
  
  function drawReflector2D(type){
    const wiring = REFLECTORS[type];
    const wiringEl = document.getElementById('reflectorWiring');
    wiringEl.innerHTML = '';
    for (let i=0;i<26;i++){
      const a = ALPH[i], b = wiring[i];
      wiringEl.innerHTML += `${a} ‚Üî ${b}<br>`;
    }

    ctx.clearRect(0,0,canvas.width,canvas.height);
    const cx = canvas.width/2, cy = canvas.height/2, r = Math.min(cx,cy)-30;
    const coords = {};
    for (let i=0;i<26;i++){
      const ang = (i/26)*Math.PI*2 - Math.PI/2;
      coords[ALPH[i]] = { x: cx + r*Math.cos(ang), y: cy + r*Math.sin(ang) };
    }
    
    // Draw connection lines
    ctx.lineWidth = 1.5;
    const drawn = new Set();
    for (let i=0;i<26;i++){
      const a = ALPH[i], b = wiring[i];
      const pair = [a,b].sort().join('');
      if (!drawn.has(pair)) {
        drawn.add(pair);
        const pa = coords[a], pb = coords[b];
        const gradient = ctx.createLinearGradient(pa.x, pa.y, pb.x, pb.y);
        gradient.addColorStop(0, `hsla(${(i*14)%360},80%,60%,0.6)`);
        gradient.addColorStop(1, `hsla(${((i*14)+40)%360},80%,60%,0.6)`);
        ctx.strokeStyle = gradient;
        ctx.beginPath();
        ctx.moveTo(pa.x, pa.y);
        ctx.lineTo(pb.x, pb.y);
        ctx.stroke();
      }
    }
    
    // Draw nodes
    ctx.font = '11px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    for (let i=0;i<26;i++){
      const p = coords[ALPH[i]];
      const gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, 8);
      gradient.addColorStop(0, `hsl(${(i*14)%360},70%,70%)`);
      gradient.addColorStop(1, `hsl(${(i*14)%360},70%,50%)`);
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(p.x, p.y, 6, 0, Math.PI*2);
      ctx.fill();
      ctx.strokeStyle = '#0a0e27';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      ctx.fillStyle = '#f1f5f9';
      ctx.fillText(ALPH[i], p.x, p.y-15);
    }
  }
  
  drawReflector2D(reflectorSelect.value);

  reflectorSelect.addEventListener('change', (e)=>{ 
    drawReflector2D(e.target.value); 
    document.getElementById('reflector').value = e.target.value; 
    reflectorLabel.textContent = e.target.value; 
  });

  document.getElementById('reflector').addEventListener('change', function(e){ 
    reflectorSelect.value = this.value; 
    drawReflector2D(this.value); 
    reflectorLabel.textContent = this.value; 
  });

  // ==================== THREE.JS 3D ====================
  let THREE, scene, camera, renderer, nodes3D = [], beamsGroup;
  
  (async function init3D(){
    try {
      const mod = await import('https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js');
      THREE = mod;
    } catch(err){
      console.error('Three.js import error:', err);
      return;
    }
    
    const container = document.getElementById('reflector3D');
    renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    renderer.setClearColor(0x000000, 0);
    container.appendChild(renderer.domElement);

    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(50, container.clientWidth/container.clientHeight, 0.1, 1000);
    camera.position.set(0, 0, 25);
    
    scene.add(new THREE.AmbientLight(0x333333));
    const pl = new THREE.PointLight(0x6699ff, 1.5);
    pl.position.set(5, 5, 15);
    scene.add(pl);

    const radius = 8;
    const geom = new THREE.SphereGeometry(0.5, 20, 20);
    
    for (let i=0;i<26;i++){
      const angle = (i/26)*Math.PI*2;
      const hue = (i*14)%360;
      const color = new THREE.Color(`hsl(${hue},100%,60%)`);
      const mat = new THREE.MeshStandardMaterial({ 
        color, 
        emissive: color,
        emissiveIntensity: 0.3,
        metalness: 0.7,
        roughness: 0.3
      });
      const mesh = new THREE.Mesh(geom, mat);
      mesh.position.set(
        radius*Math.cos(angle), 
        radius*Math.sin(angle), 
        0
      );
      mesh.userData = { letter: ALPH[i], baseY: radius*Math.sin(angle) };
      scene.add(mesh);
      nodes3D.push(mesh);
    }
    
    beamsGroup = new THREE.Group();
    scene.add(beamsGroup);

    window.addEventListener('resize', ()=> {
      const w = container.clientWidth, h = container.clientHeight;
      renderer.setSize(w, h);
      camera.aspect = w/h;
      camera.updateProjectionMatrix();
    });

    animate3D();
  })();

  function animate3D(){
    requestAnimationFrame(animate3D);
    if (!nodes3D.length) return;
    
    const time = Date.now() * 0.001;
    nodes3D.forEach((n, i) => { 
      n.rotation.y += 0.01;
      n.position.y = n.userData.baseY + Math.sin(time * 2 + i * 0.2) * 0.3;
    });
    
    if (beamsGroup) {
      beamsGroup.rotation.z += 0.002;
    }
    
    if (renderer && scene && camera) renderer.render(scene, camera);
  }

  function triggerReflectorHit(letterIn, letterOut){
    if (!nodes3D.length || !THREE) return;
    const nodeIn = nodes3D.find(n=>n.userData.letter===letterIn);
    const nodeOut = nodes3D.find(n=>n.userData.letter===letterOut);
    if (!nodeIn || !nodeOut) return;

    // Pulse effect on nodes
    nodeIn.material.emissiveIntensity = 1;
    nodeOut.material.emissiveIntensity = 1;
    setTimeout(() => {
      nodeIn.material.emissiveIntensity = 0.3;
      nodeOut.material.emissiveIntensity = 0.3;
    }, 600);

    const color = new THREE.Color(`hsl(${Math.random()*360},100%,70%)`);
    const start = nodeIn.position.clone();
    const end = nodeOut.position.clone();
    const dir = new THREE.Vector3().subVectors(end, start);
    const length = dir.length();
    
    const beamGeom = new THREE.CylinderGeometry(0.1, 0.1, 1, 8, 1, true);
    const beamMat = new THREE.MeshBasicMaterial({ 
      color, 
      transparent: true, 
      opacity: 0.9, 
      depthWrite: false 
    });
    const beam = new THREE.Mesh(beamGeom, beamMat);
    
    beam.position.copy(start.clone().add(end).multiplyScalar(0.5));
    beam.scale.set(1, length, 1);
    beam.lookAt(end);
    beam.rotateX(Math.PI/2);
    beamsGroup.add(beam);

    let t = 0;
    const fadeInterval = setInterval(()=>{
      t += 0.06;
      beam.material.opacity = Math.max(0, 0.9 - t);
      if (t >= 0.9){
        beamsGroup.remove(beam);
        beam.geometry.dispose();
        beam.material.dispose();
        clearInterval(fadeInterval);
      }
    }, 30);
  }

  // ==================== MACHINE LOGIC ====================
  function makeMachine(){
    const leftSpec = document.getElementById('rotorLeft').value;
    const midSpec = document.getElementById('rotorMid').value;
    const rightSpec = document.getElementById('rotorRight').value;
    const refSpec = document.getElementById('reflector').value;
    
    const ringL = (document.getElementById('ringLeft').value || 'A').toUpperCase().charCodeAt(0)-65;
    const ringM = (document.getElementById('ringMid').value || 'A').toUpperCase().charCodeAt(0)-65;
    const ringR = (document.getElementById('ringRight').value || 'A').toUpperCase().charCodeAt(0)-65;
    const posL = (document.getElementById('posLeft').value || 'A').toUpperCase().charCodeAt(0)-65;
    const posM = (document.getElementById('posMid').value || 'A').toUpperCase().charCodeAt(0)-65;
    const posR = (document.getElementById('posRight').value || 'A').toUpperCase().charCodeAt(0)-65;
    const plug = parsePlugboard(document.getElementById('plugboard').value);

    const left = new Rotor(rotorsSpec[leftSpec], ringL, posL);
    const mid = new Rotor(rotorsSpec[midSpec], ringM, posM);
    const right = new Rotor(rotorsSpec[rightSpec], ringR, posR);
    const reflector = REFLECTORS[refSpec];

    return {left, mid, right, reflector, plug};
  }

  function stepRotors(m){
    const rightAtNotch = m.right.atNotch();
    const midAtNotch = m.mid.atNotch();

    if (midAtNotch) { m.mid.step(); m.left.step(); }
    if (rightAtNotch) { m.mid.step(); }
    m.right.step();
  }

  function appendLog(s){ 
    const t = document.createElement('div'); 
    t.textContent = s; 
    t.style.marginBottom = '4px';
    logEl.appendChild(t); 
    logEl.scrollTop = logEl.scrollHeight; 
  }

  function animatePath(pathArr){
    if (!pathArr || pathArr.length === 0) {
      outChar.textContent = '-';
      lastPath.textContent = 'Jalur sinyal akan muncul di sini...';
      return;
    }
    
    const finalChar = (pathArr[pathArr.length-1] && pathArr[pathArr.length-1][1]) || '-';
    outChar.textContent = finalChar;
    lastPath.textContent = pathArr.map(p => p && p[0] && p[1] ? `${p[0]}: ${p[1]}` : '').filter(x => x).join(' ‚Üí ');
    
    lightOut.classList.add('on');
    setTimeout(() => lightOut.classList.remove('on'), 1000);
  }

  function encodeChar(machine, ch){
    if (!ALPH.includes(ch)) return {out: ch, path: []};
    
    stepRotors(machine);
    document.getElementById('leftPos').textContent = ALPH[machine.left.pos];
    document.getElementById('midPos').textContent = ALPH[machine.mid.pos];
    document.getElementById('rightPos').textContent = ALPH[machine.right.pos];

    const path = [];
    path.push(['IN', ch]);
    
    const plugIn = machine.plug[ch] || ch;
    path.push(['PLUG', plugIn]);

    let c = idx(plugIn);
    const rOut = machine.right.forward(c); 
    path.push(['R‚Üí', chr(rOut)]);
    
    const mOut = machine.mid.forward(rOut); 
    path.push(['M‚Üí', chr(mOut)]);
    
    const lOut = machine.left.forward(mOut); 
    path.push(['L‚Üí', chr(lOut)]);

    const reflectedLetter = machine.reflector[lOut];
    const refOut = ALPH.indexOf(reflectedLetter);
    path.push(['REF', reflectedLetter]);

    try { 
      triggerReflectorHit(chr(lOut), reflectedLetter); 
    } catch(e) {}

    const lBack = machine.left.backward(refOut); 
    path.push(['L‚Üê', chr(lBack)]);
    
    const mBack = machine.mid.backward(lBack); 
    path.push(['M‚Üê', chr(mBack)]);
    
    const rBack = machine.right.backward(mBack); 
    path.push(['R‚Üê', chr(rBack)]);

    const plugOut = machine.plug[chr(rBack)] || chr(rBack);
    path.push(['PLUG', plugOut]);
    path.push(['OUT', plugOut]);

    return {out: plugOut, path};
  }

  // ==================== CONTROLS ====================
  runBtn.onclick = ()=>{
    const machine = makeMachine();
    const text = inputText.value;
    let out = '';
    
    appendLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    appendLog('üöÄ Memulai enkripsi/dekripsi...');
    appendLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    for (let ch of text){
      const res = encodeChar(machine, ch.toUpperCase());
      out += res.out;
      if (res.path.length > 0) {
        appendLog(`${ch} ‚Üí ${res.out}  |  ${res.path.map(x=>x[1]).join(' ')}`);
      } else {
        appendLog(`${ch} ‚Üí ${res.out}  (non-letter)`);
      }
      animatePath(res.path);
    }
    
    outChar.textContent = out;
    ciphertextEl.innerHTML = `<span style="color: var(--accent-cyan);">${out}</span>`;
    
    appendLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    appendLog('‚úÖ Selesai! Hasil: ' + out);
    appendLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  }

  stepBtn.onclick = ()=>{
    const machine = (window._stepMachine) ? window._stepMachine : makeMachine();
    window._stepMachine = machine;
    
    const ch = (inputText.value[0] || '');
    if (!ch){ 
      appendLog('‚ö†Ô∏è Tidak ada karakter untuk diproses.'); 
      return; 
    }
    
    inputText.value = inputText.value.slice(1);
    const res = encodeChar(machine, ch.toUpperCase());
    
    if (res.path.length > 0) {
      appendLog(`‚ñ∂Ô∏è ${ch} ‚Üí ${res.out}  |  ${res.path.map(x=>x[1]).join(' ')}`);
    } else {
      appendLog(`‚ñ∂Ô∏è ${ch} ‚Üí ${res.out}  (non-letter)`);
    }
    
    animatePath(res.path);
    
    // Update ciphertext accumulation
    const currentText = ciphertextEl.textContent;
    if (currentText.includes('Hasil akan muncul')) {
      ciphertextEl.innerHTML = `<span style="color: var(--accent-cyan);">${res.out}</span>`;
    } else {
      ciphertextEl.innerHTML += res.out;
    }
    
    window._stepMachine = machine;
  }

  resetBtn.onclick = ()=>{
    window._stepMachine = undefined;
    drawReflector2D(reflectorSelect.value);
    appendLog('üîÑ Reset ke posisi awal.');
    
    document.getElementById('leftPos').textContent = (document.getElementById('posLeft').value || 'A').toUpperCase();
    document.getElementById('midPos').textContent = (document.getElementById('posMid').value || 'A').toUpperCase();
    document.getElementById('rightPos').textContent = (document.getElementById('posRight').value || 'A').toUpperCase();
    
    outChar.textContent = '-';
    lastPath.textContent = 'Jalur sinyal akan muncul di sini...';
    ciphertextEl.innerHTML = '<span style="color: var(--text-muted); font-style: italic;">Hasil akan muncul di sini...</span>';
  }

  clearLog.onclick = ()=>{ 
    logEl.innerHTML = ''; 
    appendLog('üìã Log dibersihkan.');
  }

  // Copy button functionality
  copyBtn.onclick = ()=>{
    const text = ciphertextEl.textContent;
    if (text && !text.includes('Hasil akan muncul')) {
      navigator.clipboard.writeText(text).then(()=>{
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '‚úÖ Copied!';
        copyBtn.style.background = 'linear-gradient(135deg, var(--accent-green), var(--accent-cyan))';
        copyBtn.style.color = 'white';
        setTimeout(()=>{
          copyBtn.innerHTML = originalText;
          copyBtn.style.background = '';
          copyBtn.style.color = '';
        }, 2000);
      }).catch(err => {
        appendLog('‚ùå Gagal menyalin: ' + err);
      });
    } else {
      appendLog('‚ö†Ô∏è Tidak ada teks untuk disalin.');
    }
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && e.target.id === 'inputText'){ 
      runBtn.click(); 
      e.preventDefault(); 
    }
  });

  // Initial log message
  appendLog('üëã Selamat datang di Enigma Machine Visualizer!');
  appendLog('üí° Ketik pesan, atur konfigurasi, lalu klik "Enkripsi/Dekripsi"');
  appendLog('');
  </script>
</body>
</html>